apiVersion: batch/v1
kind: Job
metadata:
  name: "{{ .Release.Name }}-memgraph-test-cluster-setup"
  labels:
    {{- include "memgraph.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": test
spec:
  template:
    metadata:
      labels:
        app: memgraph
    spec:
      containers:
      - name: memgraph-test-cluster-setup
        image: memgraph/memgraph:2.16.0
        command: ["/bin/sh", "-c"]
        args:
        - |
          check_mgconsole() {
            local host=$1
            local command=$2
            local expected=$3

            result=$(echo $command | mgconsole --host $host --port 7687)
            if [[ $result != *$expected* ]]; then
              echo "Unexpected mgconsole result for host $host:"
              echo $result
              exit 1
            fi
          }

          check_mgconsole "memgraph-coordinator-1.default.svc.cluster.local" "SHOW INSTANCES;" "coordinator_1"
          check_mgconsole "memgraph-coordinator-2.default.svc.cluster.local" "SHOW INSTANCES;" "coordinator_2"
          check_mgconsole "memgraph-coordinator-3.default.svc.cluster.local" "SHOW INSTANCES;" "coordinator_3"
          check_mgconsole "memgraph-data-0.default.svc.cluster.local" "RETURN 0;" "0"
          check_mgconsole "memgraph-data-1.default.svc.cluster.local" "RETURN 0;" "0"
      restartPolicy: Never
  backoffLimit: 4
