apiVersion: batch/v1
kind: Job
metadata:
  name: cluster-setup
  annotations:
    "helm.sh/hook": post-install
spec:
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: cluster-setup
        image: "{{ $.Values.image.repository }}:{{ $.Values.image.tag }}"
        command: ["/bin/bash", "-c"]
        args:
        - |
          set -e  # Exit on error

          echo "Waiting for Memgraph coordinators to be ready..."

          # Function to wait for a service to be ready
          wait_for_service() {
            local host=$1
            local port=$2
            local max_attempts=60
            local attempt=0

            while [ $attempt -lt $max_attempts ]; do
              echo "Checking $host:$port (attempt $((attempt+1))/$max_attempts)"

              if timeout 5 bash -c "cat < /dev/null > /dev/tcp/$host/$port" 2>/dev/null; then
                echo "✅ $host:$port is ready"
                return 0
              fi

              attempt=$((attempt+1))
              sleep 5
            done

            echo "❌ Timeout waiting for $host:$port"
            return 1
          }

          # Wait for all coordinators
          wait_for_service "memgraph-coordinator-1.default.svc.cluster.local" 7687
          wait_for_service "memgraph-coordinator-2.default.svc.cluster.local" 7687
          wait_for_service "memgraph-coordinator-3.default.svc.cluster.local" 7687

          # Wait for all data instances
          wait_for_service "memgraph-data-0.default.svc.cluster.local" 7687
          wait_for_service "memgraph-data-1.default.svc.cluster.local" 7687

          # Check if instances are already registered 
          INSTANCE_COUNT=$(echo "SHOW INSTANCES;" | mgconsole --host memgraph-coordinator-1.default.svc.cluster.local --port 7687 --output-format=csv 2>/dev/null | tail -n +2 | wc -l)
          if [ "$INSTANCE_COUNT" -gt 1 ]; then
            echo "✅ Cluster already configured with $INSTANCE_COUNT instances. Skipping registration."
            exit 0
          fi
      

          echo 'ADD COORDINATOR 1 WITH CONFIG {"bolt_server": "memgraph-coordinator-1.default.svc.cluster.local:7687", "management_server":  "memgraph-coordinator-1.default.svc.cluster.local:10000", "coordinator_server":  "memgraph-coordinator-1.default.svc.cluster.local:12000"};' | mgconsole --host memgraph-coordinator-1.default.svc.cluster.local --port 7687
          echo 'ADD COORDINATOR 2 WITH CONFIG {"bolt_server": "memgraph-coordinator-2.default.svc.cluster.local:7687", "management_server":  "memgraph-coordinator-2.default.svc.cluster.local:10000", "coordinator_server":  "memgraph-coordinator-2.default.svc.cluster.local:12000"};' | mgconsole --host memgraph-coordinator-1.default.svc.cluster.local --port 7687
          echo 'ADD COORDINATOR 3 WITH CONFIG {"bolt_server": "memgraph-coordinator-3.default.svc.cluster.local:7687", "management_server":  "memgraph-coordinator-3.default.svc.cluster.local:10000", "coordinator_server":  "memgraph-coordinator-3.default.svc.cluster.local:12000"};' | mgconsole --host memgraph-coordinator-1.default.svc.cluster.local --port 7687
          echo 'REGISTER INSTANCE instance_1 WITH CONFIG {"bolt_server": "memgraph-data-0.default.svc.cluster.local:7687", "management_server": "memgraph-data-0.default.svc.cluster.local:10000", "replication_server": "memgraph-data-0.default.svc.cluster.local:20000"};' | mgconsole --host memgraph-coordinator-1.default.svc.cluster.local --port 7687
          echo 'REGISTER INSTANCE instance_2 WITH CONFIG {"bolt_server": "memgraph-data-1.default.svc.cluster.local:7687", "management_server": "memgraph-data-1.default.svc.cluster.local:10000", "replication_server": "memgraph-data-1.default.svc.cluster.local:20000"};' | mgconsole --host memgraph-coordinator-1.default.svc.cluster.local --port 7687
          echo 'SET INSTANCE instance_1 TO MAIN;' | mgconsole --host memgraph-coordinator-1.default.svc.cluster.local --port 7687