{{- $hasCert := false }}
  {{- $hasKey := false }}
  {{- range (index .Values.coordinators 0).args }}
    {{- if hasPrefix "--bolt-cert-file" . }}{{- $hasCert = true }}{{- end }}
    {{- if hasPrefix "--bolt-key-file" . }}{{- $hasKey = true }}{{- end }}
  {{- end }}
  {{- $useSSL := and $hasCert $hasKey | ternary "--use-ssl" "" }}

apiVersion: batch/v1
kind: Job
metadata:
  name: cluster-setup
  annotations:
    "helm.sh/hook": post-install
spec:
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: cluster-setup
          image: "{{ $.Values.image.repository }}:{{ $.Values.image.tag }}"
          command: ["/bin/bash", "-c"]
          args:
            - |
              set -e  # Exit on error

              echo "Waiting for Memgraph coordinators to be ready..."

              # Function to wait for a service to be ready
              wait_for_service() {
                local host=$1
                local port=$2
                local max_attempts=60
                local attempt=0

                while [ $attempt -lt $max_attempts ]; do
                  echo "Checking $host:$port (attempt $((attempt+1))/$max_attempts)"

                  if timeout 5 bash -c "cat < /dev/null > /dev/tcp/$host/$port" 2>/dev/null; then
                    echo "✅ $host:$port is ready"
                    return 0
                  fi

                  attempt=$((attempt+1))
                  sleep 5
                done

                echo "❌ Timeout waiting for $host:$port"
                return 1
              }

              # Wait for all coordinators
              {{- range .Values.coordinators }}
              wait_for_service "memgraph-coordinator-{{ .id }}.{{ $.Release.Namespace }}.svc.cluster.local" {{ $.Values.ports.boltPort }}
              {{- end }}

              # Wait for all data instances
              {{- range .Values.data }}
              wait_for_service "memgraph-data-{{ .id }}.{{ $.Release.Namespace }}.svc.cluster.local" {{ $.Values.ports.boltPort }}
              {{- end }}

              # Check if instances are already registered
              INSTANCE_COUNT=$(echo "SHOW INSTANCES;" | mgconsole {{ $useSSL }} --host memgraph-coordinator-{{ (index .Values.coordinators 0).id }}.{{ .Release.Namespace }}.svc.cluster.local --port {{$.Values.ports.boltPort }} --output-format=csv 2>/dev/null | tail -n +2 | wc -l)
              if [ "$INSTANCE_COUNT" -gt 1 ]; then
                echo "✅ Cluster already configured with $INSTANCE_COUNT instances. Skipping registration."
                exit 0
              fi

              # Add all coordinators
              {{- range .Values.coordinators }}
              echo 'ADD COORDINATOR {{ .id }} WITH CONFIG {"bolt_server": "memgraph-coordinator-{{ .id }}.{{ $.Release.Namespace }}.svc.cluster.local:{{ $.Values.ports.boltPort }}", "management_server": "memgraph-coordinator-{{ .id }}.{{ $.Release.Namespace }}.svc.cluster.local:{{ $.Values.ports.managementPort }}", "coordinator_server": "memgraph-coordinator-{{ .id }}.{{$.Release.Namespace }}.svc.cluster.local:{{ $.Values.ports.coordinatorPort }}"};' | mgconsole {{ $useSSL }} --host memgraph-coordinator-{{ (index $.Values.coordinators 0).id }}.{{ $.Release.Namespace}}.svc.cluster.local --port {{ $.Values.ports.boltPort }}
              {{- end }}

              # Register all data instances
              {{- range $index, $instance := .Values.data }}
              echo 'REGISTER INSTANCE instance_{{ add $index 1 }} WITH CONFIG {"bolt_server": "memgraph-data-{{ $instance.id }}.{{ $.Release.Namespace }}.svc.cluster.local:{{$.Values.ports.boltPort }}", "management_server": "memgraph-data-{{ $instance.id }}.{{ $.Release.Namespace }}.svc.cluster.local:{{ $.Values.ports.managementPort }}", "replication_server": "memgraph-data-{{ $instance.id }}.{{ $.Release.Namespace }}.svc.cluster.local:{{ $.Values.ports.replicationPort }}"};' | mgconsole {{ $useSSL }} --host memgraph-coordinator-{{ (index $.Values.coordinators 0).id }}.{{ $.Release.Namespace }}.svc.cluster.local --port {{ $.Values.ports.boltPort }}
              {{- end }}

              # Set first data instance as MAIN
              echo 'SET INSTANCE instance_1 TO MAIN;' | mgconsole {{ $useSSL }} --host memgraph-coordinator-{{ (index .Values.coordinators 0).id }}.{{ $.Release.Namespace }}.svc.cluster.local --port {{ $.Values.ports.boltPort }}
